## 8. 常见问题场景优化

### 8.1 问题："本月收入是多少"

**优化配置**：

```yaml
术语:
  名称: 收入
  同义词: 营收、营业收入、销售收入
  描述: |
    收入类科目的发生额合计，通常指主营业务收入和其他业务收入。
    科目编码：5001（主营业务收入）、5051（其他业务收入）
    计算：SUM(贷方发生额 - 借方发生额)
    数据来源：gl_detail 或 gl_balance

SQL示例:
  问题: 本月收入是多少
  SQL: |
    SELECT 
        SUM(COALESCE(d.localcreditamount, 0) - COALESCE(d.localdebitamount, 0)) AS 本月收入
    FROM gl_voucher v
    INNER JOIN gl_detail d ON v.pk_voucher = d.pk_voucher
    INNER JOIN bd_accsubj s ON d.pk_accsubj = s.pk_accsubj
    WHERE v.dr = 0 AND d.dr = 0
      AND v.vouchstatus >= 3
      AND v.cyear = EXTRACT(YEAR FROM CURRENT_DATE)
      AND v.cmonth = EXTRACT(MONTH FROM CURRENT_DATE)
      AND (s.accsubjcode LIKE '5001%' OR s.accsubjcode LIKE '5051%')
```

### 8.2 问题："现金余额"

**优化配置**：

```yaml
术语:
  名称: 现金余额
  同义词: 库存现金、现金
  描述: |
    库存现金科目的期末余额。
    科目编码：1001（库存现金）
    数据来源：gl_balance.endbalance

SQL示例:
  问题: 现金余额是多少
  SQL: |
    SELECT 
        s.accsubjcode AS 科目编码,
        s.accsubjname AS 科目名称,
        b.endbalance AS 现金余额
    FROM gl_balance b
    INNER JOIN bd_accsubj s ON b.pk_accsubj = s.pk_accsubj
    WHERE b.cyear = EXTRACT(YEAR FROM CURRENT_DATE)
      AND b.cmonth = EXTRACT(MONTH FROM CURRENT_DATE)
      AND s.accsubjcode = '1001'
      AND s.dr = 0
```

### 8.3 问题："利润表"

**优化配置**：

```yaml
术语:
  名称: 利润表
  同义词: 损益表、收益表
  描述: |
    反映企业一定期间经营成果的财务报表。
    主要项目：营业收入、营业成本、期间费用、利润总额、净利润
    计算逻辑：
    - 营业收入 = 5001（主营业务收入）+ 5051（其他业务收入）
    - 营业成本 = 6001（主营业务成本）+ 6051（其他业务成本）
    - 期间费用 = 6601（销售费用）+ 6602（管理费用）+ 6603（财务费用）
    - 利润总额 = 营业收入 - 营业成本 - 期间费用 + 营业外收支
    - 净利润 = 利润总额 - 所得税费用

SQL示例:
  问题: 本月利润表
  SQL: |
    WITH income AS (
        SELECT SUM(COALESCE(d.localcreditamount, 0) - COALESCE(d.localdebitamount, 0)) AS amount
        FROM gl_voucher v
        INNER JOIN gl_detail d ON v.pk_voucher = d.pk_voucher
        INNER JOIN bd_accsubj s ON d.pk_accsubj = s.pk_accsubj
        WHERE v.dr = 0 AND d.dr = 0 AND v.vouchstatus >= 3
          AND v.cyear = EXTRACT(YEAR FROM CURRENT_DATE)
          AND v.cmonth = EXTRACT(MONTH FROM CURRENT_DATE)
          AND s.accsubjcode LIKE '5%'
    ),
    cost AS (
        SELECT SUM(COALESCE(d.localdebitamount, 0) - COALESCE(d.localcreditamount, 0)) AS amount
        FROM gl_voucher v
        INNER JOIN gl_detail d ON v.pk_voucher = d.pk_voucher
        INNER JOIN bd_accsubj s ON d.pk_accsubj = s.pk_accsubj
        WHERE v.dr = 0 AND d.dr = 0 AND v.vouchstatus >= 3
          AND v.cyear = EXTRACT(YEAR FROM CURRENT_DATE)
          AND v.cmonth = EXTRACT(MONTH FROM CURRENT_DATE)
          AND s.accsubjcode LIKE '6%'
    )
    SELECT 
        i.amount AS 营业收入,
        c.amount AS 营业成本及费用,
        i.amount - c.amount AS 净利润
    FROM income i, cost c
```

