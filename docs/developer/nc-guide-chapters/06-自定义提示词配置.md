## 6. 自定义提示词配置

### 6.1 NC 系统通用规则

```yaml
提示词名称: NC系统通用查询规则
类型: 问 SQL
生效数据源: NC财务系统

提示词内容: |
  在生成查询 NC 财务系统的 SQL 时，请遵循以下规则：
  
  ## 数据有效性
  1. 所有表查询必须加 dr = 0 条件，排除已删除记录
  2. 单据类查询需判断 billstatus 状态，通常 >= 2 表示已审核
  3. 凭证查询需判断 vouchstatus 状态，>= 3 表示已记账
  
  ## 字段处理
  4. 金额字段可能为 NULL，使用 COALESCE(字段, 0) 处理
  5. 主键字段以 pk_ 开头，外键关联时注意字段名匹配
  6. 日期字段格式为 DATE 类型,可直接进行日期运算
  
  ## 期间处理
  7. 会计年度使用 cyear（4位数字），会计期间使用 cmonth（1-12）
  8. 查询"本月"时使用 EXTRACT(YEAR FROM CURRENT_DATE) 和 EXTRACT(MONTH FROM CURRENT_DATE)
  9. 年初余额使用 cmonth = 0 或查询 cmonth = 1 的期初值
  
  ## 表关联
  10. 凭证明细需关联 gl_voucher 和 gl_detail
  11. 科目信息需关联 bd_accsubj 表
  12. 组织信息需关联 org_orgs 或 org_financeorg 表
```

### 6.2 科目查询规则

```yaml
提示词名称: 科目余额查询规则
类型: 问 SQL
生效数据源: NC财务系统

提示词内容: |
  查询科目余额相关数据时，请遵循以下规则：
  
  1. 科目余额优先从 gl_balance 表查询，性能更好
  2. 如需凭证级明细，则从 gl_detail 表汇总
  3. 科目编码规则：
     - 1xxx: 资产类（借方余额为正）
     - 2xxx: 负债类（贷方余额为正）
     - 3xxx: 权益类（贷方余额为正）
     - 4xxx: 成本类
     - 5xxx: 收入类
     - 6xxx: 费用类
  4. 只统计末级科目（isleaf = 'Y'）的数据，非末级科目是汇总值
  5. 期末余额计算：
     - 资产类：期初 + 借方 - 贷方
     - 负债/权益类：期初 - 借方 + 贷方
```

### 6.3 期间处理规则

```yaml
提示词名称: 会计期间处理规则
类型: 问 SQL
生效数据源: NC财务系统

提示词内容: |
  处理会计期间相关查询时，请遵循以下规则：
  
  1. "本月" = 当前系统日期所在月份
     条件：cyear = EXTRACT(YEAR FROM CURRENT_DATE) AND cmonth = EXTRACT(MONTH FROM CURRENT_DATE)
  
  2. "上月" 需考虑跨年：
     - 如果当前是1月，上月是去年12月
     - 使用 CASE WHEN 或日期函数处理
  
  3. "本季度" 计算：
     - Q1: cmonth IN (1, 2, 3)
     - Q2: cmonth IN (4, 5, 6)
     - Q3: cmonth IN (7, 8, 9)
     - Q4: cmonth IN (10, 11, 12)
  
  4. "本年累计" 条件：
     cyear = EXTRACT(YEAR FROM CURRENT_DATE) AND cmonth BETWEEN 1 AND 当前月
  
  5. "去年同期" 计算：
     cyear = EXTRACT(YEAR FROM CURRENT_DATE) - 1 AND cmonth = EXTRACT(MONTH FROM CURRENT_DATE)
```

### 6.4 金额计算规则

```yaml
提示词名称: 金额计算规则
类型: 问 SQL
生效数据源: NC财务系统

提示词内容: |
  计算金额相关数据时，请遵循以下规则：
  
  ## 收入计算
  1. 收入 = 贷方发生额 - 借方发生额（收入类科目贷方增加）
  2. 主营业务收入：科目编码 5001%
  3. 其他业务收入：科目编码 5051%
  4. 营业外收入：科目编码 5301%
  
  ## 成本费用计算
  5. 成本/费用 = 借方发生额 - 贷方发生额（成本费用类科目借方增加）
  6. 主营业务成本：科目编码 6001%
  7. 销售费用：科目编码 6601%
  8. 管理费用：科目编码 6602%
  9. 财务费用：科目编码 6603%
  
  ## 利润计算
  10. 毛利润 = 营业收入 - 营业成本
  11. 净利润 = 收入类科目贷方合计 - 成本费用类科目借方合计
  12. 毛利率 = 毛利润 / 营业收入 × 100%
  13. 净利率 = 净利润 / 营业收入 × 100%
  
  ## 余额方向
  14. 资产类科目（1xxx）：借方余额为正常方向
  15. 负债类科目（2xxx）：贷方余额为正常方向
  16. 权益类科目（3xxx）：贷方余额为正常方向
  17. 损益类科目期末余额应为0（已结转）
```

### 6.5 辅助核算规则

```yaml
提示词名称: 辅助核算查询规则
类型: 问 SQL
生效数据源: NC财务系统

提示词内容: |
  查询辅助核算相关数据时，请遵循以下规则：
  
  ## 数据来源
  1. 辅助核算余额：优先从 gl_accass 表查询
  2. 辅助核算明细：从 gl_freevalue 表关联 gl_detail 查询
  3. 辅助项档案：根据类型关联对应档案表
  
  ## 常用辅助核算类型及关联
  4. 客户辅助：
     - 档案表：bd_customer
     - 关联字段：pk_customer
     - 常用科目：1122（应收账款）、2203（预收账款）
  
  5. 供应商辅助：
     - 档案表：bd_supplier
     - 关联字段：pk_supplier
     - 常用科目：2202（应付账款）、1123（预付账款）
  
  6. 部门辅助：
     - 档案表：org_dept
     - 关联字段：pk_dept
     - 常用科目：6601/6602/6603（期间费用）
  
  7. 项目辅助：
     - 档案表：bd_project
     - 关联字段：pk_project
     - 常用科目：1604（在建工程）、6401-6403（成本）
  
  ## 查询注意事项
  8. gl_accass 表中 pk_assid 是辅助项主键，需根据辅助类型关联对应档案表
  9. 一个科目可能启用多个辅助核算，需要正确处理多维度查询
  10. 辅助核算余额查询时同样需要指定 cyear 和 cmonth
```

### 6.6 财务报表规则

```yaml
提示词名称: 财务报表生成规则
类型: 问 SQL
生效数据源: NC财务系统

提示词内容: |
  生成财务报表相关数据时，请遵循以下规则：
  
  ## 资产负债表
  1. 资产类项目：科目编码 1xxx 的期末余额
     - 货币资金：1001（库存现金）+ 1002（银行存款）
     - 应收账款：1122
     - 预付账款：1123
     - 存货：1401-1499
     - 固定资产：1601（原值）- 1602（累计折旧）
     - 无形资产：1701（原值）- 1702（累计摊销）
  
  2. 负债类项目：科目编码 2xxx 的期末余额
     - 短期借款：2001
     - 应付账款：2202
     - 预收账款：2203
     - 应付职工薪酬：2211
     - 应交税费：2221
  
  3. 所有者权益：科目编码 3xxx 的期末余额
     - 实收资本：3001
     - 资本公积：3002
     - 盈余公积：3101
     - 未分配利润：3103
  
  ## 利润表
  4. 利润表项目从损益类科目（5xxx、6xxx）本期发生额计算
  5. 收入项目取贷方发生额，成本费用项目取借方发生额
  6. 利润表是期间报表，需要指定具体期间范围
  
  ## 报表平衡校验
  7. 资产 = 负债 + 所有者权益（资产负债表恒等式）
  8. 借方合计 = 贷方合计（凭证试算平衡）
  
  ## 数据来源选择
  9. 余额类数据优先从 gl_balance 表取数，性能更优
  10. 发生额明细需要从 gl_detail 表汇总计算
```

### 6.7 多组织查询规则

```yaml
提示词名称: 多组织查询规则
类型: 问 SQL
生效数据源: NC财务系统

提示词内容: |
  处理多组织（集团/多公司）查询时，请遵循以下规则：
  
  ## 组织层级
  1. 集团层级：pk_group 标识集团
  2. 组织层级：pk_org 标识具体财务组织/公司
  3. 组织表：org_orgs（组织）、org_financeorg（财务组织）
  
  ## 单组织查询
  4. 查询单个公司数据时，必须加 pk_org = <指定组织> 条件
  5. 如果用户提到具体公司名称，需要先关联 org_orgs 获取 pk_org
  
  ## 多组织汇总
  6. 集团合并查询时，不加 pk_org 条件，汇总所有组织数据
  7. 多公司对比时，按 pk_org 或组织名称分组统计
  8. 关联组织表获取组织名称：org_orgs.name
  
  ## 内部往来处理
  9. 集团合并报表需要抵消内部往来
  10. 内部往来科目通常有专门的辅助核算标识
  
  ## 权限控制
  11. 实际查询时可能需要考虑用户的组织权限
  12. 跨组织查询需要确认用户是否有对应权限
  
  ## 示例条件
  - 单公司：WHERE v.pk_org = '指定组织pk'
  - 集团汇总：不加 pk_org 限制，或 WHERE v.pk_group = '集团pk'
  - 多公司对比：GROUP BY o.name（关联 org_orgs）
```

